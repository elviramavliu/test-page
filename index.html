<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤</title>

  <script>window.yaContextCb = window.yaContextCb || []</script>
  <script src="https://yandex.ru/ads/system/context.js" async></script>

  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    body { margin: 0; padding: 15px; font-family: Arial; background: #f0f0f0; min-height: 100vh; }
    .test-container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
    .banner-frame { border: 2px dashed #ccc; margin: 20px 0; padding: 15px; min-height: 250px; background: #fff; }
    .controls { margin: 20px 0; padding: 15px; background: #f8f8f8; border-radius: 6px; display: flex; flex-wrap: wrap; gap: 10px; position: relative; }
    button { padding: 10px 20px; border: none; border-radius: 4px; background: #007bff; color: white; cursor: pointer; transition: 0.3s; }
    button:hover { background: #0056b3; }
    .debug-info { color: #666; font-size: 0.9em; margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    @media (max-width: 768px) {
      .test-container { padding: 10px; }
      .banner-frame { margin: 10px 0; min-height: 200px; }
      button { width: 100%; margin: 5px 0; }
    }
    .banner-form { margin: 15px 0; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 6px; }
    .form-row { margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .param-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; width: 100%; }
    .param-input { display: flex; flex-direction: column; }
    .param-input label { font-size: 0.8em; color: #666; margin-bottom: 3px; }
    input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }

    /* –°—Ç–∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö */
    .guidelines {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }
    .banner-bounds {
      position: absolute;
      border: 1px dashed rgba(0, 150, 255, 0.3);
      background: rgba(0, 150, 255, 0.1);
    }
    .coordinate-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: white;
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 12px;
      z-index: 10000;
    }

    /* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö */
    .guidelines-settings {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      z-index: 10000;
      display: none;
    }
    .guidelines-settings label { font-size: 12px; margin-right: 5px; }
  </style>
</head>
<body>
<div class="test-container">
  <h1>–¢–µ—Å—Ç–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤</h1>

  <div class="controls">
    <button onclick="softReload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button onclick="confirmClearBanner()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button onclick="showForm()">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä</button>
    <button onclick="toggleGuidelines()" style="background: #28a745;">–õ–∏–Ω–µ–π–∫–∞</button>
    <button onclick="toggleGuidelinesSettings()" style="background: #6c757d;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö -->
  <div class="guidelines" id="guidelines"></div>

  <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö -->
  <div class="guidelines-settings" id="guidelinesSettings">
    <div>
      <label for="gridColor">–¶–≤–µ—Ç –ª–∏–Ω–∏–π:</label>
      <input type="color" id="gridColor" value="#ff0000">
    </div>
    <div>
      <label for="lineThickness">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–π:</label>
      <input type="number" id="lineThickness" value="1" min="1" max="10">
    </div>
    <button onclick="applyGuidelinesSettings()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  </div>

  <div class="banner-form" id="bannerForm" style="display: none;">
    <div class="form-row">
      <div class="param-group">
        <div class="param-input">
          <label>Owner ID (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="text" id="ownerId" placeholder="391204" required>
        </div>
        <div class="param-input">
          <label>Container ID</label>
          <input type="text" id="containerId" placeholder="adfox_123">
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="param-group">
        <div class="param-input">
          <label>–ü–∞—Ä–∞–º–µ—Ç—Ä p1</label>
          <input type="text" id="paramP1" placeholder="dcokb">
        </div>
        <div class="param-input">
          <label>–ü–∞—Ä–∞–º–µ—Ç—Ä p2</label>
          <input type="text" id="paramP2" placeholder="jaap">
        </div>
        <div class="param-input">
          <label>–ü–∞—Ä–∞–º–µ—Ç—Ä pfc</label>
          <input type="text" id="paramPfc" placeholder="dzokd">
        </div>
        <div class="param-input">
          <label>–ü–∞—Ä–∞–º–µ—Ç—Ä pfb</label>
          <input type="text" id="paramPfb" placeholder="bghwdj">
        </div>
        <div class="param-input">
          <label>puid1</label>
          <input type="text" id="paramPuid1">
        </div>
        <div class="param-input">
          <label>puid2</label>
          <input type="text" id="paramPuid2">
        </div>
        <div class="param-input">
          <label>puid3</label>
          <input type="text" id="paramPuid3">
        </div>
      </div>
    </div>
    <div class="form-row">
      <button onclick="addNewBanner()">–°–æ–∑–¥–∞—Ç—å</button>
      <button onclick="hideForm()" style="background: #dc3545;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div class="banner-frame" id="bannerContainer"></div>
  <div class="debug-info" id="debugOutput"></div>
</div>

<script>
  /******************** –£—Ç–∏–ª–∏—Ç—ã ********************/
  function formatTime(date) {
    return date.toLocaleTimeString('ru-RU', { hour12: false });
  }

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è HEX —Ü–≤–µ—Ç–∞ –≤ rgba —Å –∑–∞–¥–∞–Ω–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é
  function hexToRgba(hex, opacity) {
    let r = 0, g = 0, b = 0;
    if(hex.length === 4) {
      r = "0x" + hex[1] + hex[1];
      g = "0x" + hex[2] + hex[2];
      b = "0x" + hex[3] + hex[3];
    } else if(hex.length === 7) {
      r = "0x" + hex[1] + hex[2];
      g = "0x" + hex[3] + hex[4];
      b = "0x" + hex[5] + hex[6];
    }
    return "rgba(" + +r + "," + +g + "," + +b + "," + opacity + ")";
  }

  /******************** –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ********************/
  let bannerCounter = 1;
  let currentBanners = [];
  let guidelinesVisible = false;
  let guidelinesAnimationFrameID;
  let guidelinesSettingsVisible = false;
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  let guidelinesConfig = {
    color: "rgba(255, 0, 0, 0.5)",
    thickness: 1
  };

  /******************** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ********************/
  document.addEventListener('DOMContentLoaded', () => {
    const savedData = sessionStorage.getItem('bannerData');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        data.forEach(params => createBanner(params, false));
        logMessage('üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      } catch(e) {
        logMessage('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
      }
    }
    window.addEventListener('resize', debounce(onResize, 200));
  });

  function onResize() {
    if(guidelinesVisible) {
      updateGuidelines();
    }
  }

  /******************** –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ********************/
  function logMessage(message) {
    const debug = document.getElementById('debugOutput');
    const time = formatTime(new Date());
    debug.innerHTML += `<div>${time}: ${message}</div>`;
    debug.scrollTop = debug.scrollHeight;
  }

  /******************** –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–Ω–Ω–µ—Ä–∞–º–∏ ********************/
  function showForm() {
    document.getElementById('bannerForm').style.display = 'block';
  }

  function hideForm() {
    document.getElementById('bannerForm').style.display = 'none';
    clearForm();
  }

  function clearForm() {
    document.getElementById('ownerId').value = '';
    document.getElementById('containerId').value = '';
    document.getElementById('paramP1').value = '';
    document.getElementById('paramP2').value = '';
    document.getElementById('paramPfc').value = '';
    document.getElementById('paramPfb').value = '';
    document.getElementById('paramPuid1').value = '';
    document.getElementById('paramPuid2').value = '';
    document.getElementById('paramPuid3').value = '';
  }

  function addNewBanner() {
    const params = {
      ownerId: document.getElementById('ownerId').value,
      containerId: document.getElementById('containerId').value || `adfox_${Date.now()}`,
      p1: document.getElementById('paramP1').value,
      p2: document.getElementById('paramP2').value,
      pfc: document.getElementById('paramPfc').value,
      pfb: document.getElementById('paramPfb').value,
      puid1: document.getElementById('paramPuid1').value,
      puid2: document.getElementById('paramPuid2').value,
      puid3: document.getElementById('paramPuid3').value
    };

    if (!params.ownerId) {
      alert('–í–≤–µ–¥–∏—Ç–µ Owner ID');
      return;
    }

    // –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞ –æ—á–∏—â–∞–µ–º –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    clearBanner(true);
    createBanner(params);
    saveState();
    hideForm();
  }

  function createBanner(params, log = true) {
    const banner = document.createElement('div');
    banner.id = params.containerId;
    banner.classList.add('banner-iframe-container');
    document.getElementById('bannerContainer').appendChild(banner);

    window.yaContextCb.push(() => {
      try {
        Ya.adfoxCode.create({
          ownerId: params.ownerId,
          containerId: params.containerId,
          params: {
            p1: params.p1 || '',
            p2: params.p2 || '',
            pfc: params.pfc || '',
            pfb: params.pfb || '',
            puid1: params.puid1 || '',
            puid2: params.puid2 || '',
            puid3: params.puid3 || ''
          }
        });
        currentBanners.push(params);
        if(log) logMessage(`‚úÖ –ë–∞–Ω–Ω–µ—Ä #${bannerCounter++} —Å–æ–∑–¥–∞–Ω`);
        if(guidelinesVisible) {
          updateGuidelines();
        }
      } catch(error) {
        logMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
      }
    });
  }

  // –§—É–Ω–∫—Ü–∏—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –±–∞–Ω–Ω–µ—Ä–æ–≤
  function confirmClearBanner() {
    if(confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–∞–Ω–Ω–µ—Ä—ã?')) {
      clearBanner();
    }
  }

  function clearBanner(skipConfirm = false) {
    if(!skipConfirm && !confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–∞–Ω–Ω–µ—Ä—ã?')) {
      return;
    }
    document.getElementById('bannerContainer').innerHTML = '';
    currentBanners = [];
    sessionStorage.removeItem('bannerData');
    if(guidelinesVisible) {
      document.getElementById('guidelines').innerHTML = '';
    }
    logMessage('‚ö†Ô∏è –í—Å–µ –±–∞–Ω–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã');
  }

  function softReload() {
    const temp = [...currentBanners];
    clearBanner(true);
    setTimeout(() => temp.forEach(p => createBanner(p)), 100);
    logMessage('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
  }

  function saveState() {
    sessionStorage.setItem('bannerData', JSON.stringify(currentBanners));
  }

  /******************** –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö ********************/
  function toggleGuidelines() {
    guidelinesVisible = !guidelinesVisible;
    const guidelines = document.getElementById('guidelines');
    guidelines.style.display = guidelinesVisible ? 'block' : 'none';

    if(guidelinesVisible) {
      updateGuidelines();
      startGuidelinesAnimation();
      logMessage('üìè –†–µ–∂–∏–º –∏–∑–º–µ—Ä–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    } else {
      stopGuidelinesAnimation();
      logMessage('üìè –†–µ–∂–∏–º –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
    }
  }

  function updateGuidelines() {
    const container = document.getElementById('bannerContainer');
    const containerRect = container.getBoundingClientRect();
    const guidelines = document.getElementById('guidelines');
    guidelines.innerHTML = '';

    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è)
    const vLine = document.createElement('div');
    vLine.style.position = 'absolute';
    vLine.style.width = `${guidelinesConfig.thickness}px`;
    vLine.style.background = guidelinesConfig.color;
    vLine.style.height = `${containerRect.height}px`;
    vLine.style.left = `${containerRect.left + containerRect.width / 2}px`;
    vLine.style.top = `${containerRect.top}px`;

    const hLine = document.createElement('div');
    hLine.style.position = 'absolute';
    hLine.style.height = `${guidelinesConfig.thickness}px`;
    hLine.style.background = guidelinesConfig.color;
    hLine.style.width = `${containerRect.width}px`;
    hLine.style.left = `${containerRect.left}px`;
    hLine.style.top = `${containerRect.top + containerRect.height / 2}px`;

    guidelines.appendChild(vLine);
    guidelines.appendChild(hLine);

    // –°–µ—Ç–∫–∞: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å —à–∞–≥–æ–º 100px
    const verticalSpacing = 100;
    for(let x = containerRect.left; x < containerRect.right; x += verticalSpacing) {
      const gridLine = document.createElement('div');
      gridLine.style.position = 'absolute';
      gridLine.style.width = `${guidelinesConfig.thickness}px`;
      gridLine.style.background = guidelinesConfig.color;
      gridLine.style.height = `${containerRect.height}px`;
      gridLine.style.left = `${x}px`;
      gridLine.style.top = `${containerRect.top}px`;
      gridLine.style.opacity = 0.3;
      guidelines.appendChild(gridLine);
    }

    // –°–µ—Ç–∫–∞: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å —à–∞–≥–æ–º 100px
    const horizontalSpacing = 100;
    for(let y = containerRect.top; y < containerRect.bottom; y += horizontalSpacing) {
      const gridLine = document.createElement('div');
      gridLine.style.position = 'absolute';
      gridLine.style.height = `${guidelinesConfig.thickness}px`;
      gridLine.style.background = guidelinesConfig.color;
      gridLine.style.width = `${containerRect.width}px`;
      gridLine.style.left = `${containerRect.left}px`;
      gridLine.style.top = `${y}px`;
      gridLine.style.opacity = 0.3;
      guidelines.appendChild(gridLine);
    }

    // –ì—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞
    const banners = container.getElementsByClassName('banner-iframe-container');
    Array.from(banners).forEach(banner => {
      const bRect = banner.getBoundingClientRect();
      const bounds = document.createElement('div');
      bounds.className = 'banner-bounds';
      bounds.style.width = `${bRect.width}px`;
      bounds.style.height = `${bRect.height}px`;
      bounds.style.left = `${bRect.left}px`;
      bounds.style.top = `${bRect.top}px`;
      guidelines.appendChild(bounds);
    });
  }

  function startGuidelinesAnimation() {
    function animate() {
      if(guidelinesVisible) {
        updateGuidelines();
        guidelinesAnimationFrameID = requestAnimationFrame(animate);
      }
    }
    guidelinesAnimationFrameID = requestAnimationFrame(animate);
  }

  function stopGuidelinesAnimation() {
    cancelAnimationFrame(guidelinesAnimationFrameID);
  }

  /******************** –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏—Ö ********************/
  function toggleGuidelinesSettings() {
    guidelinesSettingsVisible = !guidelinesSettingsVisible;
    document.getElementById('guidelinesSettings').style.display = guidelinesSettingsVisible ? 'block' : 'none';
  }

  function applyGuidelinesSettings() {
    const colorInput = document.getElementById('gridColor').value;
    const thicknessInput = document.getElementById('lineThickness').value;
    guidelinesConfig.color = hexToRgba(colorInput, 0.5);
    guidelinesConfig.thickness = parseInt(thicknessInput, 10);
    updateGuidelines();
  }
</script>
</body>
</html>
